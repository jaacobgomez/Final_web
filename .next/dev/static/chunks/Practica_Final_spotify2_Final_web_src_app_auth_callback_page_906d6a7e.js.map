{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///home/jacobgomez/tercero/Web_I/Practica_Final/spotify2/Final_web/src/app/auth/callback/page.js"],"sourcesContent":["'use client';\n\nimport { useEffect, useState, useRef } from 'react';\nimport { useRouter, useSearchParams } from 'next/navigation';\nimport { saveTokens } from '@/lib/auth';\n\nexport default function CallbackPage() {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const [error, setError] = useState(null);\n  const hasProcessed = useRef(false);\n  console.log('CallbackPage rendered with searchParams:', Array.from(searchParams.entries()));\n\n  useEffect(() => {\n    // Prevenir ejecución duplicada\n    if (hasProcessed.current) return;\n\n    const code = searchParams.get('code');\n    const state = searchParams.get('state');\n    const errorParam = searchParams.get('error');\n\n    if (errorParam) {\n      setError('Autenticación cancelada');\n      return;\n    }\n\n    if (!code) {\n      setError('No se recibió código de autorización');\n      return;\n    }\n\n    // Validar state para prevenir CSRF\n    const savedState = localStorage.getItem('spotify_auth_state');\n    if (!state || state !== savedState) {\n      setError('Error de validación de seguridad (CSRF). Intenta iniciar sesión de nuevo.');\n      localStorage.removeItem('spotify_auth_state');\n      return;\n    }\n\n    // Limpiar state después de validar\n    localStorage.removeItem('spotify_auth_state');\n\n    // Marcar como procesado\n    hasProcessed.current = true;\n\n    // Intercambiar código por token\n    const exchangeCodeForToken = async (code) => {\n      try {\n        const response = await fetch('/api/spotify-token', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ code })\n        });\n\n        const data = await response.json();\n\n        if (!response.ok) {\n          throw new Error(data.error || 'Error al obtener token');\n        }\n\n        // Guardar tokens\n        saveTokens(data.access_token, data.refresh_token, data.expires_in);\n\n        // Redirigir al dashboard\n        router.push('/dashboard');\n\n      } catch (error) {\n        console.error('Error:', error);\n        setError(error.message);\n      }\n    };\n\n    exchangeCodeForToken(code);\n  }, [searchParams, router]);\n\n  if (error) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen bg-gray-900\">\n        <div className=\"text-center\">\n          <h1 className=\"text-2xl font-bold text-red-500 mb-4\">Error</h1>\n          <p className=\"text-white mb-6\">{error}</p>\n          <button\n            onClick={() => router.push('/')}\n            className=\"bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700\"\n          >\n            Volver al inicio\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex items-center justify-center min-h-screen bg-gray-900\">\n      <div className=\"text-center\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto mb-4\"></div>\n        <p className=\"text-white text-xl\">Autenticando...</p>\n      </div>\n    </div>\n  );\n}"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;;;AAJA;;;;AAMe,SAAS;;IACtB,MAAM,SAAS,IAAA,6LAAS;IACxB,MAAM,eAAe,IAAA,mMAAe;IACpC,MAAM,CAAC,OAAO,SAAS,GAAG,IAAA,oNAAQ,EAAC;IACnC,MAAM,eAAe,IAAA,kNAAM,EAAC;IAC5B,QAAQ,GAAG,CAAC,4CAA4C,MAAM,IAAI,CAAC,aAAa,OAAO;IAEvF,IAAA,qNAAS;kCAAC;YACR,+BAA+B;YAC/B,IAAI,aAAa,OAAO,EAAE;YAE1B,MAAM,OAAO,aAAa,GAAG,CAAC;YAC9B,MAAM,QAAQ,aAAa,GAAG,CAAC;YAC/B,MAAM,aAAa,aAAa,GAAG,CAAC;YAEpC,IAAI,YAAY;gBACd,SAAS;gBACT;YACF;YAEA,IAAI,CAAC,MAAM;gBACT,SAAS;gBACT;YACF;YAEA,mCAAmC;YACnC,MAAM,aAAa,aAAa,OAAO,CAAC;YACxC,IAAI,CAAC,SAAS,UAAU,YAAY;gBAClC,SAAS;gBACT,aAAa,UAAU,CAAC;gBACxB;YACF;YAEA,mCAAmC;YACnC,aAAa,UAAU,CAAC;YAExB,wBAAwB;YACxB,aAAa,OAAO,GAAG;YAEvB,gCAAgC;YAChC,MAAM;+DAAuB,OAAO;oBAClC,IAAI;wBACF,MAAM,WAAW,MAAM,MAAM,sBAAsB;4BACjD,QAAQ;4BACR,SAAS;gCAAE,gBAAgB;4BAAmB;4BAC9C,MAAM,KAAK,SAAS,CAAC;gCAAE;4BAAK;wBAC9B;wBAEA,MAAM,OAAO,MAAM,SAAS,IAAI;wBAEhC,IAAI,CAAC,SAAS,EAAE,EAAE;4BAChB,MAAM,IAAI,MAAM,KAAK,KAAK,IAAI;wBAChC;wBAEA,iBAAiB;wBACjB,IAAA,8KAAU,EAAC,KAAK,YAAY,EAAE,KAAK,aAAa,EAAE,KAAK,UAAU;wBAEjE,yBAAyB;wBACzB,OAAO,IAAI,CAAC;oBAEd,EAAE,OAAO,OAAO;wBACd,QAAQ,KAAK,CAAC,UAAU;wBACxB,SAAS,MAAM,OAAO;oBACxB;gBACF;;YAEA,qBAAqB;QACvB;iCAAG;QAAC;QAAc;KAAO;IAEzB,IAAI,OAAO;QACT,qBACE,wOAAC;YAAI,WAAU;sBACb,cAAA,wOAAC;gBAAI,WAAU;;kCACb,wOAAC;wBAAG,WAAU;kCAAuC;;;;;;kCACrD,wOAAC;wBAAE,WAAU;kCAAmB;;;;;;kCAChC,wOAAC;wBACC,SAAS,IAAM,OAAO,IAAI,CAAC;wBAC3B,WAAU;kCACX;;;;;;;;;;;;;;;;;IAMT;IAEA,qBACE,wOAAC;QAAI,WAAU;kBACb,cAAA,wOAAC;YAAI,WAAU;;8BACb,wOAAC;oBAAI,WAAU;;;;;;8BACf,wOAAC;oBAAE,WAAU;8BAAqB;;;;;;;;;;;;;;;;;AAI1C;GA9FwB;;QACP,6LAAS;QACH,mMAAe;;;KAFd"}}]
}