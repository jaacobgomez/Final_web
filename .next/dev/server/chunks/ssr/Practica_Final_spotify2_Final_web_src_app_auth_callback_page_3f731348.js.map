{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///home/jacobgomez/tercero/Web_I/Practica_Final/spotify2/Final_web/src/app/auth/callback/page.js"],"sourcesContent":["'use client';\n\nimport { useEffect, useState, useRef } from 'react';\nimport { useRouter, useSearchParams } from 'next/navigation';\nimport { saveTokens } from '@/lib/auth';\n\nexport default function CallbackPage() {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const [error, setError] = useState(null);\n  const hasProcessed = useRef(false);\n  console.log('CallbackPage rendered with searchParams:', Array.from(searchParams.entries()));\n\n  useEffect(() => {\n    // Prevenir ejecución duplicada\n    if (hasProcessed.current) return;\n\n    const code = searchParams.get('code');\n    const state = searchParams.get('state');\n    const errorParam = searchParams.get('error');\n\n    if (errorParam) {\n      setError('Autenticación cancelada');\n      return;\n    }\n\n    if (!code) {\n      setError('No se recibió código de autorización');\n      return;\n    }\n\n    // Validar state para prevenir CSRF\n    const savedState = localStorage.getItem('spotify_auth_state');\n    if (!state || state !== savedState) {\n      setError('Error de validación de seguridad (CSRF). Intenta iniciar sesión de nuevo.');\n      localStorage.removeItem('spotify_auth_state');\n      return;\n    }\n\n    // Limpiar state después de validar\n    localStorage.removeItem('spotify_auth_state');\n\n    // Marcar como procesado\n    hasProcessed.current = true;\n\n    // Intercambiar código por token\n    const exchangeCodeForToken = async (code) => {\n      try {\n        const response = await fetch('/api/spotify-token', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ code })\n        });\n\n        const data = await response.json();\n\n        if (!response.ok) {\n          throw new Error(data.error || 'Error al obtener token');\n        }\n\n        // Guardar tokens\n        saveTokens(data.access_token, data.refresh_token, data.expires_in);\n\n        // Redirigir al dashboard\n        router.push('/dashboard');\n\n      } catch (error) {\n        console.error('Error:', error);\n        setError(error.message);\n      }\n    };\n\n    exchangeCodeForToken(code);\n  }, [searchParams, router]);\n\n  if (error) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen bg-gray-900\">\n        <div className=\"text-center\">\n          <h1 className=\"text-2xl font-bold text-red-500 mb-4\">Error</h1>\n          <p className=\"text-white mb-6\">{error}</p>\n          <button\n            onClick={() => router.push('/')}\n            className=\"bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700\"\n          >\n            Volver al inicio\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex items-center justify-center min-h-screen bg-gray-900\">\n      <div className=\"text-center\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto mb-4\"></div>\n        <p className=\"text-white text-xl\">Autenticando...</p>\n      </div>\n    </div>\n  );\n}"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AAJA;;;;;AAMe,SAAS;IACtB,MAAM,SAAS,IAAA,0LAAS;IACxB,MAAM,eAAe,IAAA,gMAAe;IACpC,MAAM,CAAC,OAAO,SAAS,GAAG,IAAA,4PAAQ,EAAC;IACnC,MAAM,eAAe,IAAA,0PAAM,EAAC;IAC5B,QAAQ,GAAG,CAAC,4CAA4C,MAAM,IAAI,CAAC,aAAa,OAAO;IAEvF,IAAA,6PAAS,EAAC;QACR,+BAA+B;QAC/B,IAAI,aAAa,OAAO,EAAE;QAE1B,MAAM,OAAO,aAAa,GAAG,CAAC;QAC9B,MAAM,QAAQ,aAAa,GAAG,CAAC;QAC/B,MAAM,aAAa,aAAa,GAAG,CAAC;QAEpC,IAAI,YAAY;YACd,SAAS;YACT;QACF;QAEA,IAAI,CAAC,MAAM;YACT,SAAS;YACT;QACF;QAEA,mCAAmC;QACnC,MAAM,aAAa,aAAa,OAAO,CAAC;QACxC,IAAI,CAAC,SAAS,UAAU,YAAY;YAClC,SAAS;YACT,aAAa,UAAU,CAAC;YACxB;QACF;QAEA,mCAAmC;QACnC,aAAa,UAAU,CAAC;QAExB,wBAAwB;QACxB,aAAa,OAAO,GAAG;QAEvB,gCAAgC;QAChC,MAAM,uBAAuB,OAAO;YAClC,IAAI;gBACF,MAAM,WAAW,MAAM,MAAM,sBAAsB;oBACjD,QAAQ;oBACR,SAAS;wBAAE,gBAAgB;oBAAmB;oBAC9C,MAAM,KAAK,SAAS,CAAC;wBAAE;oBAAK;gBAC9B;gBAEA,MAAM,OAAO,MAAM,SAAS,IAAI;gBAEhC,IAAI,CAAC,SAAS,EAAE,EAAE;oBAChB,MAAM,IAAI,MAAM,KAAK,KAAK,IAAI;gBAChC;gBAEA,iBAAiB;gBACjB,IAAA,2KAAU,EAAC,KAAK,YAAY,EAAE,KAAK,aAAa,EAAE,KAAK,UAAU;gBAEjE,yBAAyB;gBACzB,OAAO,IAAI,CAAC;YAEd,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,UAAU;gBACxB,SAAS,MAAM,OAAO;YACxB;QACF;QAEA,qBAAqB;IACvB,GAAG;QAAC;QAAc;KAAO;IAEzB,IAAI,OAAO;QACT,qBACE,yRAAC;YAAI,WAAU;sBACb,cAAA,yRAAC;gBAAI,WAAU;;kCACb,yRAAC;wBAAG,WAAU;kCAAuC;;;;;;kCACrD,yRAAC;wBAAE,WAAU;kCAAmB;;;;;;kCAChC,yRAAC;wBACC,SAAS,IAAM,OAAO,IAAI,CAAC;wBAC3B,WAAU;kCACX;;;;;;;;;;;;;;;;;IAMT;IAEA,qBACE,yRAAC;QAAI,WAAU;kBACb,cAAA,yRAAC;YAAI,WAAU;;8BACb,yRAAC;oBAAI,WAAU;;;;;;8BACf,yRAAC;oBAAE,WAAU;8BAAqB;;;;;;;;;;;;;;;;;AAI1C"}}]
}